services:
  gateway:
    build: ./gateway
    container_name: media-gateway
    environment:
      JWT_SECRET: super-secret-change-me
      AUTH_USER: kgcmina@admin
      AUTH_PASS: kgcmina@admin
      MEDIA_BASE_URL: http://172.30.148.6:8080
    ports:
      - "3333:3333"
    volumes:
      - ./.storage:/storage

  nginx:
    image: nginx:1.27-alpine
    container_name: media-nginx
    depends_on:
      - gateway
    ports:
      - "8080:8080"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./.storage:/storage

  retention:
    image: node:24-alpine
    container_name: media-retention
    working_dir: /app
    volumes:
      - ./retention:/app
      - ./.storage:/storage
    environment:
      RETENTION_INTERVAL_MS: 2 * 60 * 60 * 1000        # limpeza a cada 2 horas
      RETENTION_TTL_IMAGES: 365d                       # remove imagens com > 1 ano
      RETENTION_TTL_VIDEOS: 365d                       # remove vÃ­deos com > 1 ano
    command: ["node", "worker.js"]